# ATS Document Converter - Development Environment
# Includes all development tools for linting, testing, and static analysis

FROM python:3.13-slim

# Set shell with pipefail for better error handling
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libcairo2-dev \
    libpango1.0-dev \
    libgdk-pixbuf-xlib-2.0-dev \
    libffi-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    pandoc \
    fonts-liberation \
    fonts-noto-color-emoji \
    fonts-dejavu-core \
    ghostscript \
    libcairo2 \
    libpango-1.0-0 \
    libgdk-pixbuf-xlib-2.0-0 \
    libffi8 \
    libjpeg62-turbo \
    libpng16-16 \
    libfreetype6 \
    libharfbuzz0b \
    libfribidi0 \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install uv using pip (more reliable in Docker)
RUN pip install --no-cache-dir uv==0.7.3
ENV PATH="/root/.local/bin:$PATH"

# Verify uv installation
RUN uv --version

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

# Create app directory
WORKDIR /app

# Copy project files
COPY pyproject.toml .
COPY src/ ./src/
COPY templates/ ./templates/
COPY examples/ ./examples/

# Create a minimal README.md for the build process
RUN printf '# ATS PDF Generator\n\nConvert Markdown documents to ATS-optimized PDFs for job applications.\n' > README.md

# Install dependencies including dev tools
RUN uv venv && uv pip install .[dev]

# Remove README.md as it's not needed in the final image
RUN rm README.md

# Create a non-root user for development
RUN useradd -m -s /bin/bash developer && \
    chown -R developer:developer /app

# Switch to non-root user
USER developer

# Set up pre-commit hooks (optional)
RUN uv pip install pre-commit

# Create useful aliases for development
RUN echo 'alias lint="ruff check ."' >> ~/.bashrc && \
    echo 'alias format="ruff format ."' >> ~/.bashrc && \
    echo 'alias typecheck="mypy src/"' >> ~/.bashrc && \
    echo 'alias test="pytest"' >> ~/.bashrc && \
    echo 'alias all-checks="ruff check . && mypy src/ && pytest"' >> ~/.bashrc

# Default command
CMD ["bash"]
